image: docker:latest

variables:
  VERSION: "7.2"
  PHP_V: "error"
  IMG_NAME: "jitesoft/php-fpm"
  DOCKER_FILE: "${VERSION}/Dockerfile"

before_script:
  - docker login -u ${DOCKER_HUB_USER} -p ${DOCKER_HUB_PASSWORD}
  - docker pull php:${VERSION}-fpm-alpine

after_script:
    - docker run --rm ${IMG_NAME}:${VERSION} php -v

php 7.2:
  stage: deploy
  script:
    - BUILD=$(docker build --no-cache -q -f ${DOCKER_FILE} .)
    - PHP_V=$(docker inspect -f '{{range $index, $value := .Config.Env}}{{if eq (index (split $value "=") 0) "PHP_VERSION" }}{{range $i, $part := (split $value "=")}}{{if gt $i 1}}{{print "="}}{{end}}{{if gt $i 0}}{{print $part}}{{end}}{{end}}{{end}}{{end}}' ${BUILD})
    - echo "Building for php v ${PHP_V}. The image build hash is ${BUILD}"
    - TAGS="${PHP_V} 7 stable latest"
    - for tag in ${TAGS}; do docker tag ${BUILD} ${IMG_NAME}:${tag}; docker push ${IMG_NAME}:${tag}; done
  only:
    - master

php 7.1:
  stage: deploy
  variables:
    VERSION: "7.1"
  script:
    - BUILD=$(docker build --no-cache -q -f ${DOCKER_FILE} .)
    - PHP_V=$(docker inspect -f '{{range $index, $value := .Config.Env}}{{if eq (index (split $value "=") 0) "PHP_VERSION" }}{{range $i, $part := (split $value "=")}}{{if gt $i 1}}{{print "="}}{{end}}{{if gt $i 0}}{{print $part}}{{end}}{{end}}{{end}}{{end}}' ${BUILD})
    - echo "Building for php v ${PHP_V}. The image build hash is ${BUILD}"
    - TAGS="${PHP_V}"
    - for tag in ${TAGS}; do docker tag ${BUILD} ${IMG_NAME}:${tag}; docker push ${IMG_NAME}:${tag}; done
  only:
    - master

php 7.0:
  stage: deploy
  variables:
    VERSION: "7.0"
  script:
    - BUILD=$(docker build --no-cache -q -f ${DOCKER_FILE} .)
    - PHP_V=$(docker inspect -f '{{range $index, $value := .Config.Env}}{{if eq (index (split $value "=") 0) "PHP_VERSION" }}{{range $i, $part := (split $value "=")}}{{if gt $i 1}}{{print "="}}{{end}}{{if gt $i 0}}{{print $part}}{{end}}{{end}}{{end}}{{end}}' ${BUILD})
    - echo "Building for php v ${PHP_V}. The image build hash is ${BUILD}"
    - TAGS="${PHP_V}"
    - for tag in ${TAGS}; do docker tag ${BUILD} ${IMG_NAME}:${tag}; docker push ${IMG_NAME}:${tag}; done
  only:
    - master

php 5.6:
  stage: deploy
  variables:
    VERSION: "5.6"
  script:
    - BUILD=$(docker build --no-cache -q -f ${DOCKER_FILE} .)
    - PHP_V=$(docker inspect -f '{{range $index, $value := .Config.Env}}{{if eq (index (split $value "=") 0) "PHP_VERSION" }}{{range $i, $part := (split $value "=")}}{{if gt $i 1}}{{print "="}}{{end}}{{if gt $i 0}}{{print $part}}{{end}}{{end}}{{end}}{{end}}' ${BUILD})
    - echo "Building for php v ${PHP_V}. The image build hash is ${BUILD}"
    - TAGS="${PHP_V} 5"
    - for tag in ${TAGS}; do docker tag ${BUILD} ${IMG_NAME}:${tag}; docker push ${IMG_NAME}:${tag}; done
  only:
    - master
